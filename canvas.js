data = JSON.parse('{"status":true,"message":"获取数据成功","data":{"departmentStructure":{"id":"e3caf5225fb141e3b2a754414a215ec1","admin_id":"370fee2c65b911e688db00163e00371a","admin_name":"老大","name":"薪人薪事-z梦","parent_id":"0","is_root":1,"employee_count":5,"regular_count":3,"labour_count":2,"children_ids":["380a8af9f6f44dad92d09304ba1ae2b5","412461299f214698baf40b9b007031fc","4d44c0ed119347ab952fee02d9cdf5dc","89c73cdbc93a43408bdc6de31b83ba40","9de2611c714e406dbce2ef05b054d7e0","b6101c5f0caa47c287e9b666c0f27d1f"],"division_id":"","division_settable":false,"children":[{"id":"b6101c5f0caa47c287e9b666c0f27d1f","admin_id":"0","admin_name":"","name":"qwe","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["8053241433c1482f86c2199936ef93af"],"division_id":"","division_settable":true,"children":[{"id":"8053241433c1482f86c2199936ef93af","admin_id":"0","admin_name":"","name":"123","parent_id":"b6101c5f0caa47c287e9b666c0f27d1f","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["66ed047d2d2d420d8161288fa1ed5d34"],"division_id":"","division_settable":true,"children":[{"children":[{"id":"1b806c63fa3448d5a1b612f7eedf9096","admin_id":"0","admin_name":"","name":"hdfgd","parent_id":"66ed047d2d2d420d8161288fa1ed5d34","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":true,"employee_count_with_sub":0}],"id":"66ed047d2d2d420d8161288fa1ed5d34","admin_id":"0","admin_name":"","name":"fsg","parent_id":"8053241433c1482f86c2199936ef93af","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["1b806c63fa3448d5a1b612f7eedf9096"],"division_id":"","division_settable":true,"employee_count_with_sub":0}],"employee_count_with_sub":0}],"employee_count_with_sub":0},{"children":[{"id":"4a156fdfc57f4b4c940774fe52cfbd95","admin_id":"0","admin_name":"","name":"gfgsd","parent_id":"412461299f214698baf40b9b007031fc","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":0},{"id":"17ff8367c9974d7283e02340c8770d05","admin_id":"0","admin_name":"","name":"qweq","parent_id":"412461299f214698baf40b9b007031fc","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":0}],"id":"412461299f214698baf40b9b007031fc","admin_id":"0","admin_name":"","name":"hjk","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["17ff8367c9974d7283e02340c8770d05","4a156fdfc57f4b4c940774fe52cfbd95"],"division_id":"5a432442ed61493697745a45e3decdb0","division_settable":false,"employee_count_with_sub":0},{"children":[{"id":"fa1b64be6c484248a74dad5a5b4608cd","admin_id":"0","admin_name":"","name":"hjg","parent_id":"4d44c0ed119347ab952fee02d9cdf5dc","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"bacb20f724b3437f83df83c3b4393031","division_settable":false,"employee_count_with_sub":0},{"id":"ca0233937d2648bd90414e23f372c604","admin_id":"0","admin_name":"","name":"hgf","parent_id":"4d44c0ed119347ab952fee02d9cdf5dc","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["100a3b45d8a4417c92689edd0415e697"],"division_id":"b70aed9a8c8f4313936d19491d315df2","division_settable":false,"children":[{"children":[{"id":"96e74772967847aeb92772df5fc1182a","admin_id":"0","admin_name":"","name":"nncvb","parent_id":"100a3b45d8a4417c92689edd0415e697","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":0}],"id":"100a3b45d8a4417c92689edd0415e697","admin_id":"0","admin_name":"","name":"qweafsd","parent_id":"ca0233937d2648bd90414e23f372c604","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["96e74772967847aeb92772df5fc1182a"],"division_id":"","division_settable":false,"employee_count_with_sub":0}],"employee_count_with_sub":0}],"id":"4d44c0ed119347ab952fee02d9cdf5dc","admin_id":"0","admin_name":"","name":"中关村","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":3,"regular_count":3,"labour_count":0,"children_ids":["ca0233937d2648bd90414e23f372c604","fa1b64be6c484248a74dad5a5b4608cd"],"division_id":"","division_settable":false,"employee_count_with_sub":3},{"children":[{"id":"e95ebeb21d364892a29bb172ed83dda2","admin_id":"370fee2c65b911e688db00163e00371a","admin_name":"老大","name":"总裁办－二级1","parent_id":"380a8af9f6f44dad92d09304ba1ae2b5","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":0},{"id":"cef8fafab99244fab8cb2c6b6c1be4f7","admin_id":"c790927b669d11e688db00163e00371a","admin_name":"加多宝","name":"秘书处","parent_id":"380a8af9f6f44dad92d09304ba1ae2b5","is_root":0,"employee_count":1,"regular_count":1,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":1}],"id":"380a8af9f6f44dad92d09304ba1ae2b5","admin_id":"301143959c2a11e6adda00163e037d96","admin_name":"1231214","name":"总裁办","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":2,"regular_count":1,"labour_count":1,"children_ids":["cef8fafab99244fab8cb2c6b6c1be4f7","e95ebeb21d364892a29bb172ed83dda2"],"division_id":"821ce8dc54f147449e057170269c0ac8","division_settable":false,"employee_count_with_sub":3},{"id":"9de2611c714e406dbce2ef05b054d7e0","admin_id":"0","admin_name":"","name":"fghj","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":true,"employee_count_with_sub":0},{"id":"89c73cdbc93a43408bdc6de31b83ba40","admin_id":"0","admin_name":"","name":"dasf","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":true,"employee_count_with_sub":0}],"employee_count_with_sub":11},"leftEmployeeCount":5,"isDivisionOpen":1,"isInDivision":false}}')
console.log(data);

//组织架构每个小框框
function NodeTree(obj){
	this.name = obj.name;
	this.admin = obj.admin_name;
	this.employee_count = obj.employee_count;
	this.regular_count = obj.regular_count;
	this.labour_count = obj.labour_count;
	this.count = this.employee_count + '人（' + this.regular_count + '／' + this.labour_count + '）';
	this.ifSimple = obj.ifSimple == 'simple' ? true : false; 
	this.pa = obj.pa;
	this.children = [];
	this.canvas = document.createElement('canvas');
	this.ctx = this.canvas.getContext('2d');
	this.width = obj.width;
	this.height = obj.height;
	this.canvas.width = this.width;
	this.canvas.height = this.height;
	this.skin = obj.skin;
	this.textColor = obj.textColor;
	this.init();
	this.iteratorChildren(obj);

	return this
}

NodeTree.prototype = {
	//画每个节点
	init: function(){
		var t = this;
		
		//背景
		t.ctx.beginPath();
		t.roundedRect(0, 0, t.canvas.width, t.canvas.height, 5);
		t.ctx.strokeStyle = '#fff';
		t.ctx.fillStyle = t.skin;
		t.ctx.stroke();
		t.ctx.fill();

		//字体
		t.ctx.font = '10px';
		t.ctx.fillStyle = t.textColor;
		t.ctx.textAlign = 'center';    //start, end, left, right or center
		t.ctx.textBaseline = 'middle'
		t.ctx.fillText(t.name,t.width/2,15);
		t.ctx.fillText(t.count,t.width/2,30);
		t.ctx.fillText(t.admin,t.width/2,45);
	},

	//迭代数据，make 一个内有信息 ＋ canvas的数据树
	iteratorChildren: function(obj){
		var t = this;
		var children = obj.children;
		var len = children && children.length;
		var i = 0;

		if(!len){
			return;
		}else{
			for(i = 0;i<len;i++){
				var child = children[i]
				t.children.push(new NodeTree($.extend(child,{
					width: t.width,
					height: t.height,
					skin: t.skin,
					textColor:t.textColor,
				})))
			}
			
			console.log('=====')

			console.log(t.children)
		}
	},

	//画圆角矩形
	roundedRect: function(cornerX, cornerY, width, height, cornerRadius) {
		var t = this;
		if(width > 0){
			t.ctx.moveTo(cornerX + cornerRadius, cornerY);
		}else{
			t.ctx.moveTo(cornerX - cornerRadius, cornerY);
		}
		t.ctx.arcTo(cornerX+width,cornerY,cornerX + width,cornerY+height,cornerRadius);
		t.ctx.arcTo(cornerX+width,cornerY + height,cornerX,cornerY+height,cornerRadius);
		t.ctx.arcTo(cornerX,cornerY+height,cornerX,cornerY,cornerRadius);
		
		if(width> 0) {
			t.ctx.arcTo(cornerX,cornerY,cornerX+cornerRadius,cornerY,cornerRadius);
		}
		else{
			t.ctx.arcTo(cornerX,cornerY,cornerX-cornerRadius,cornerY,cornerRadius);
		}
	}
}



//canvasTree
function CanvasTree(obj){
	this.canvas = document.getElementById('canvasTree');
	this.ctx = this.canvas.getContext('2d');
	this.width = obj.width;
	this.height = obj.height;
	this.data = obj.data.data.departmentStructure;
	this.nodeHeight = 60;
	this.nodeWidth = 100;

	this.canvas.width = this.width;
	this.canvas.height = this.height;

	this.init();
	this.start();
}

CanvasTree.prototype = {
	init:function(){
		var t = this;
		//遍历data，加上编号
		t.tree = new NodeTree($.extend(this.data,{
			width: '110',
			height: '60',
			skin:'pink',
			textColor:'#fff',
		}));

	},

	start:function(){
		var t = this;
            t.loop = true;
        var raf = window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function (callback){window.setTimeout(callback, 17);};
		function ani(){
            if(!t.loop){return;}
            t.ctx.clearRect(0,0,t.canvas.width,t.canvas.height);
            
            //主循环体
            t.ctx.drawImage(t.tree.canvas,0,0,100,50)


            raf(ani);
        }
        ani();
	},
	stop:function(){
		this.loop = false
	}
}



new CanvasTree({
	width:600,
	height:400,
	data:data})