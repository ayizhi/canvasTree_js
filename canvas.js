data = JSON.parse('{"status":true,"message":"获取数据成功","data":{"departmentStructure":{"id":"e3caf5225fb141e3b2a754414a215ec1","admin_id":"370fee2c65b911e688db00163e00371a","admin_name":"老大","name":"薪人薪事-z梦","parent_id":"0","is_root":1,"employee_count":7,"regular_count":5,"labour_count":2,"children_ids":["380a8af9f6f44dad92d09304ba1ae2b5","412461299f214698baf40b9b007031fc","4d44c0ed119347ab952fee02d9cdf5dc","89c73cdbc93a43408bdc6de31b83ba40","9de2611c714e406dbce2ef05b054d7e0","b6101c5f0caa47c287e9b666c0f27d1f"],"division_id":"","division_settable":false,"children":[{"children":[{"id":"4a156fdfc57f4b4c940774fe52cfbd95","admin_id":"0","admin_name":"","name":"gfgsd","parent_id":"412461299f214698baf40b9b007031fc","is_root":0,"employee_count":1,"regular_count":1,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":1,"regular_count_with_sub":1,"labour_count_with_sub":0},{"id":"17ff8367c9974d7283e02340c8770d05","admin_id":"0","admin_name":"","name":"qweq","parent_id":"412461299f214698baf40b9b007031fc","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"id":"412461299f214698baf40b9b007031fc","admin_id":"0","admin_name":"","name":"hjk","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["17ff8367c9974d7283e02340c8770d05","4a156fdfc57f4b4c940774fe52cfbd95"],"division_id":"5a432442ed61493697745a45e3decdb0","division_settable":false,"employee_count_with_sub":1,"regular_count_with_sub":1,"labour_count_with_sub":0},{"children":[{"id":"fa1b64be6c484248a74dad5a5b4608cd","admin_id":"0","admin_name":"","name":"hjg","parent_id":"4d44c0ed119347ab952fee02d9cdf5dc","is_root":0,"employee_count":2,"regular_count":1,"labour_count":1,"children_ids":[],"division_id":"bacb20f724b3437f83df83c3b4393031","division_settable":false,"employee_count_with_sub":2,"regular_count_with_sub":1,"labour_count_with_sub":1},{"id":"ca0233937d2648bd90414e23f372c604","admin_id":"0","admin_name":"","name":"hgf","parent_id":"4d44c0ed119347ab952fee02d9cdf5dc","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["100a3b45d8a4417c92689edd0415e697"],"division_id":"b70aed9a8c8f4313936d19491d315df2","division_settable":false,"children":[{"children":[{"id":"96e74772967847aeb92772df5fc1182a","admin_id":"0","admin_name":"","name":"nncvb","parent_id":"100a3b45d8a4417c92689edd0415e697","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"id":"100a3b45d8a4417c92689edd0415e697","admin_id":"0","admin_name":"","name":"qweafsd","parent_id":"ca0233937d2648bd90414e23f372c604","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["96e74772967847aeb92772df5fc1182a"],"division_id":"","division_settable":false,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"id":"4d44c0ed119347ab952fee02d9cdf5dc","admin_id":"0","admin_name":"","name":"中关村","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":3,"regular_count":3,"labour_count":0,"children_ids":["ca0233937d2648bd90414e23f372c604","fa1b64be6c484248a74dad5a5b4608cd"],"division_id":"","division_settable":false,"employee_count_with_sub":5,"regular_count_with_sub":4,"labour_count_with_sub":1},{"id":"b6101c5f0caa47c287e9b666c0f27d1f","admin_id":"0","admin_name":"","name":"qwe","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["8053241433c1482f86c2199936ef93af"],"division_id":"","division_settable":true,"children":[{"id":"8053241433c1482f86c2199936ef93af","admin_id":"0","admin_name":"","name":"123","parent_id":"b6101c5f0caa47c287e9b666c0f27d1f","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["66ed047d2d2d420d8161288fa1ed5d34"],"division_id":"","division_settable":true,"children":[{"children":[{"id":"1b806c63fa3448d5a1b612f7eedf9096","admin_id":"0","admin_name":"","name":"hdfgd","parent_id":"66ed047d2d2d420d8161288fa1ed5d34","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":true,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"id":"66ed047d2d2d420d8161288fa1ed5d34","admin_id":"0","admin_name":"","name":"fsg","parent_id":"8053241433c1482f86c2199936ef93af","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":["1b806c63fa3448d5a1b612f7eedf9096"],"division_id":"","division_settable":true,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0},{"children":[{"id":"e95ebeb21d364892a29bb172ed83dda2","admin_id":"370fee2c65b911e688db00163e00371a","admin_name":"老大","name":"总裁办－二级1","parent_id":"380a8af9f6f44dad92d09304ba1ae2b5","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0},{"id":"cef8fafab99244fab8cb2c6b6c1be4f7","admin_id":"c790927b669d11e688db00163e00371a","admin_name":"加多宝","name":"秘书处","parent_id":"380a8af9f6f44dad92d09304ba1ae2b5","is_root":0,"employee_count":1,"regular_count":1,"labour_count":0,"children_ids":[],"division_id":"","division_settable":false,"employee_count_with_sub":1,"regular_count_with_sub":1,"labour_count_with_sub":0}],"id":"380a8af9f6f44dad92d09304ba1ae2b5","admin_id":"301143959c2a11e6adda00163e037d96","admin_name":"1231214","name":"总裁办","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":2,"regular_count":1,"labour_count":1,"children_ids":["cef8fafab99244fab8cb2c6b6c1be4f7","e95ebeb21d364892a29bb172ed83dda2"],"division_id":"821ce8dc54f147449e057170269c0ac8","division_settable":false,"employee_count_with_sub":3,"regular_count_with_sub":2,"labour_count_with_sub":1},{"id":"9de2611c714e406dbce2ef05b054d7e0","admin_id":"0","admin_name":"","name":"fghj","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":true,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0},{"id":"89c73cdbc93a43408bdc6de31b83ba40","admin_id":"0","admin_name":"","name":"dasf","parent_id":"e3caf5225fb141e3b2a754414a215ec1","is_root":0,"employee_count":0,"regular_count":0,"labour_count":0,"children_ids":[],"division_id":"","division_settable":true,"employee_count_with_sub":0,"regular_count_with_sub":0,"labour_count_with_sub":0}],"employee_count_with_sub":16,"regular_count_with_sub":12,"labour_count_with_sub":4},"leftEmployeeCount":7,"isDivisionOpen":1,"isInDivision":false}}')

//组织架构每个小框框
function NodeTree(obj){
	this.name = obj.name;
	this.admin = obj.admin_name;
	this.employee_count = obj.employee_count;
	this.regular_count = obj.regular_count;
	this.labour_count = obj.labour_count;
	this.count = this.employee_count + '人（' + this.regular_count + '／' + this.labour_count + '）';
	this.ifSimple = obj.ifSimple
	this.children = [];
	this.canvas = document.createElement('canvas');
	this.ctx = this.canvas.getContext('2d');
	this.width = obj.width;
	this.height = obj.height;
	this.skin = obj.skin;
	this.textColor = obj.textColor;
	this.ratio = obj.ratio;
	this.fontSize = 11 * this.ratio;
	this.division_id = obj.division_id;
	this.divisionIconHeight = obj.divisionIconHeight;
	this.divisionIconWidth = obj.divisionIconHeight * 3 / 2;
	this.canvas.width = this.width;
	this.canvas.height =  this.division_id ? this.height + this.divisionIconHeight : this.height;
	this.divisionIcon = this.drawDivisionIcon();
	this.init();
	this.iteratorChildren(obj);



	return this
}

NodeTree.prototype = {
	//画每个节点
	init: function(){
		var t = this;
		var startY = 0//事业部要用到

		if(t.division_id){
			startY = t.divisionIconHeight;
			//事业部icon
			t.ctx.drawImage(t.divisionIcon,10,0, t.divisionIconWidth, t.divisionIconHeight)
		}


		//背景
		t.ctx.beginPath();
		t.roundedRect(0, startY, t.width, t.height, 8);
		t.ctx.strokeStyle = '#fff';
		t.ctx.fillStyle = t.skin;
		t.ctx.stroke();
		t.ctx.fill();

		//字体
		t.ctx.font = t.fontSize + 'px serif';
		t.ctx.fillStyle = t.textColor;
		t.ctx.textAlign = 'center';    //start, end, left, right or center
		t.ctx.textBaseline = 'middle'
		t.ctx.fillText(t.name,t.width/2,t.height/4 + startY);
		t.ctx.fillText(t.count,t.width/2,t.height/2 + startY);
		if(!t.ifSimple){
			t.ctx.fillText(t.admin,t.width/2,t.height*3/4 + startY);
		}
	},

	drawDivisionIcon: function(){
		var t = this;
		var canvas = document.createElement('canvas');
		var ctx = canvas.getContext('2d');
		canvas.width = 900;
		canvas.height = 600;

		//旗杆
		ctx.beginPath();
		ctx.moveTo(0,0);
		ctx.lineTo(0,canvas.height);
		ctx.strokeStyle = t.skin;
		ctx.fillStyle = t.skin;
		ctx.lineWidth = 100;//线条的宽度
		ctx.stroke();
		ctx.fill();


		//旗面
		ctx.beginPath();
		ctx.fillStyle = t.skin;
		ctx.moveTo(40,60);
		ctx.lineTo(700,60);
		ctx.lineTo(650,160);
		ctx.lineTo(700,260);
		ctx.lineTo(10,260)
		ctx.lineWidth = 1;//线条的宽度
		ctx.strokeStyle = t.skin;//线条的颜色
		ctx.stroke();//绘制
		ctx.closePath();
		ctx.fill();

		ctx.font = '150px 宋体';
		ctx.fillStyle = t.textColor;
		ctx.textAlign = 'left';    //start, end, left, right or center
		ctx.textBaseline = 'middle'
		ctx.fillText('事业部',100,160);





		return canvas;

	},


	//迭代数据，make 一个内有信息 ＋ canvas的数据树
	iteratorChildren: function(obj){
		var t = this;
		var children = obj.children;
		var len = children && children.length;
		var i = 0;

		if(!len){
			return;
		}else{
			for(i = 0;i<len;i++){
				var child = children[i]
				t.children.push(new NodeTree($.extend(child,{
					width: t.width,
					height: t.height,
					skin: t.skin,
					textColor:t.textColor,
					ifSimple: t.ifSimple,
					ratio: t.ratio,
					divisionIconHeight: t.divisionIconHeight
				})))
			}
		}
	},

	//画圆角矩形
	roundedRect: function(cornerX, cornerY, width, height, cornerRadius) {
		var t = this;
		if(width > 0){
			t.ctx.moveTo(cornerX + cornerRadius, cornerY);
		}else{
			t.ctx.moveTo(cornerX - cornerRadius, cornerY);
		}
		t.ctx.arcTo(cornerX+width,cornerY,cornerX + width,cornerY+height,cornerRadius);
		t.ctx.arcTo(cornerX+width,cornerY + height,cornerX,cornerY+height,cornerRadius);
		t.ctx.arcTo(cornerX,cornerY+height,cornerX,cornerY,cornerRadius);
		
		if(width> 0) {
			t.ctx.arcTo(cornerX,cornerY,cornerX+cornerRadius,cornerY,cornerRadius);
		}
		else{
			t.ctx.arcTo(cornerX,cornerY,cornerX-cornerRadius,cornerY,cornerRadius);
		}
	}
}



//canvasTree
function CanvasTree(obj){
	this.canvas = document.getElementById('canvasTree');
	this.ctx = this.canvas.getContext('2d');
	this.width = obj.width;
	this.height = obj.height;
	this.data = obj.data.data.departmentStructure;

	//需要自行定义的属性
	this.nodeHeight = obj.nodeHeight || 60;
	this.nodeWidth = obj.nodeWidth || 100;
	this.marginTop = obj.marginTop || 20;
	this.marginLeft = obj.marginLeft || 20
	this.ratio = obj.ratio || 2;
	this.skin = obj.skin;
	this.textColor = obj.textColor;
	this.ifSimple = obj.ifSimple;
	this.divisionIconHeight = obj.divisionIconHeight



	this.canvas.width = this.width;
	this.canvas.height = this.height;

	this.init();
	this.start();
}

CanvasTree.prototype = {
	init:function(){
		var t = this;
		//遍历data，变成nodeTree对象
		t.tree = new NodeTree($.extend(t.data,{
			width: t.nodeWidth * t.ratio,//为了更清晰
			height: t.nodeHeight * t.ratio,
			divisionIconHeight: t.divisionIconHeight * t.ratio,
			skin: t.skin,
			textColor: t.textColor,
			ifSimple: t.ifSimple,
			ratio: t.ratio,
		}));

		//递归nodeTree对象,给每个对象加上maxwidth属性
		t.iteratorGetMaxWidth(t.tree);

		//递归nodeTree对象,给每个对象加上位置信息
		t.iteratorGetLocation(t.tree);

		console.log(t.tree)

		//获取最大宽度
		t.maxWidthNum = t.tree.maxWidth * t.nodeWidth + t.marginLeft * (t.tree.maxWidth - 1);

		//画在虚拟画布上
		t.nodeTreeCanvas = document.createElement('canvas');
		t.nodeTreeCtx = t.nodeTreeCanvas.getContext('2d');
		t.nodeTreeCanvas.width = t.maxWidthNum;
		t.nodeTreeCanvas.height = t.maxHeightNum;
		t.getNodeTreeCanvas(t.tree);
	},

	getNodeTreeCanvas: function(obj){
		var t = this;
		var i = 0;
		var startX = obj.startX;
		var startY = obj.startY;
		var tNodePic = obj.canvas;
		var nodeWidth = t.nodeWidth;
		var nodeHeight = t.nodeHeight;
		var children = obj.children;

		if(obj.division_id){
			startY -= t.divisionIconHeight;
			nodeHeight += t.divisionIconHeight;
		}

		//虚线
		if(obj.pa){
			var tStartY = obj.division_id ? startY + t.divisionIconHeight : startY;
			t.nodeTreeCtx.beginPath();
			t.nodeTreeCtx.moveTo(startX + nodeWidth/2,tStartY);
			t.nodeTreeCtx.lineTo(startX + nodeWidth/2,tStartY - t.marginTop/2);
			t.nodeTreeCtx.lineWidth = 1;//线条的宽度
			t.nodeTreeCtx.strokeStyle = "#999999";//线条的颜色
			t.nodeTreeCtx.stroke();//绘制
		}
		if(obj.children && obj.children.length){
			t.nodeTreeCtx.beginPath();
			t.nodeTreeCtx.moveTo(startX + nodeWidth/2,startY + nodeHeight);
			t.nodeTreeCtx.lineTo(startX + nodeWidth/2,startY + nodeHeight + t.marginTop/2);
			t.nodeTreeCtx.lineWidth = 1;//线条的宽度
			t.nodeTreeCtx.strokeStyle = "#999999";//线条的颜色
			t.nodeTreeCtx.stroke();//绘制
		}

		if(children && children.length){
			var len = children.length;
			var startLineX,startLineY,endLineX,endLineY;
			for(;i < len;i++){
				var child = children[i];

				if(i == 0){
					startLineX = child.startX + nodeWidth/2
					startLineY = child.startY - t.marginTop/2
				}
				if(i == len - 1){
					endLineX = child.startX + nodeWidth/2
					endLineY = child.startY - t.marginTop/2
				}

				t.getNodeTreeCanvas(child)
			}

			if(startLineX != endLineX){
				t.nodeTreeCtx.beginPath();
				t.nodeTreeCtx.moveTo(startLineX,startLineY);
				t.nodeTreeCtx.lineTo(endLineX,endLineY);
				t.nodeTreeCtx.lineWidth = 1;//线条的宽度
				t.nodeTreeCtx.strokeStyle = "#999999";//线条的颜色
				t.nodeTreeCtx.stroke();//绘制
			}
		}


		//画
		t.nodeTreeCtx.drawImage(tNodePic,0,0,obj.canvas.width,obj.canvas.height,startX,startY,nodeWidth,nodeHeight)
	},

	//递归获取最大宽度
	iteratorGetMaxWidth: function(obj){
		var t = this;
		var w = 0;
		if(obj.children && obj.children.length){
			var i = 0;
			var len = obj.children.length;
			for(;i<len;i++){
				var child = obj.children[i];
				child.pa = obj;
				w += t.iteratorGetMaxWidth(child);
				child.left = w;//用于定位
			}
			obj.maxWidth = w;
			return obj.maxWidth
		}else{
			obj.maxWidth = 1
			return obj.maxWidth;
		}
	},

	//递归获取位置信息
	iteratorGetLocation: function(obj){
		var t = this;
		var pa = obj.pa;
		var children = obj.children;
		var left = obj.left || 1;

		var marginLeft = t.marginLeft;
		var marginTop = t.marginTop;
		var width = t.nodeWidth;
		var height = t.nodeHeight;



		if(pa){
			var paWidth = pa.maxWidth;
			var maxWidth = paWidth * width + marginLeft * (paWidth - 1);
			var tWidth = obj.maxWidth;
			left = tWidth == 1 ? left : left - tWidth/2

			var paX = pa.startX;
			var paY = pa.startY;
			obj.startY = paY + marginTop + height;
			if(obj.startY + height > (t.maxHeightNum || 0)){
				t.maxHeightNum = obj.startY + height;
			}

			if(tWidth == 1 && paWidth == 1 ){
				obj.startX = paX;
			}else{
				obj.startX = paX - maxWidth / 2 + (left - 1 + tWidth/2) * width + marginLeft * (left - 1 + tWidth/2) - t.marginLeft/2
			}

			var i=0;
			if(children && children.length){
				var len = children.length;
				for(;i<len;i++){
					var child = children[i];
					t.iteratorGetLocation(child)
				}
			}

		}else{
			var maxWidth = obj.maxWidth;
			var allWidth = maxWidth * width + marginLeft * (maxWidth - 1);
			obj.startX = (allWidth - width)/2
			obj.startY = 0;
			var r = 0;
			if(children && children.length){
				var len = children.length;
				for(;r<len;r++){
					var child = children[r];
					t.iteratorGetLocation(child)
				}
			}
		}
	},

	//开始渲染
	start: function(){
		var t = this;
            t.loop = true;
        var raf = window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function (callback){window.setTimeout(callback, 17);};
		function ani(){
            if(!t.loop){return;}
            t.ctx.clearRect(0,0,t.canvas.width,t.canvas.height);
            //主循环体
            t.ctx.drawImage(t.nodeTreeCanvas,0,0, t.nodeTreeCanvas.width, t.nodeTreeCanvas.height,0,0,t.nodeTreeCanvas.width,t.nodeTreeCanvas.height)


            raf(ani);
        }
        ani();
	},
	stop: function(){
		this.loop = false
	}
}



var tree = new CanvasTree({
	width:2000,
	height:600,
	marginLeft:20,
	marginTop:30,
	ifSimple:'',//''/'simple'
	textColor:'#fff',
	skin:'#5e1724',
	nodeHeight: 60,
	nodeWidth: 110,
	divisionIconHeight:20,
	data:data,
})

//var img = tree.nodeTreeCanvas.toDataURL("image/png"),
//	doc = new jsPDF('l', 'pt',[tree.nodeTreeCanvas.width,tree.nodeTreeCanvas.height]);
//
//doc.addImage(img, 'JPEG', 20, 20);
//doc.save('techumber-html-to-pdf.pdf');